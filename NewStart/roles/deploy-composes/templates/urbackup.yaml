services:

  urbackup:
    image: uroni/urbackup-server:latest
    restart: always
    ports:
      - "{{ services_ip }}:55413:55413"
      - "{{ services_ip }}:55415:55415"
    networks:
      - proxy_network
      - backup
    environment:
      - PUID={{ docker.puid }}
      - PGID={{ docker.pgid }}
      - TZ={{ timezone }}
    volumes:
      - "{{ docker.docker_dir }}/volumes/urbackup/db:/var/urbackup"
      - "{{ docker.docker_dir }}/backups:/backups"
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.urbackup.loadbalancer.server.port=55414"
      - "traefik.http.routers.urbackup.rule=Host(`backup.{{ docker.domain }}`)"
      - "traefik.http.routers.urbackup.entrypoints=websecure"

  urbackup-client:
    image: uroni/urbackup-client:latest
    restart: always
    depends_on:
      - urbackup
    environment:
      - TZ={{ timezone }}
      - URBACKUP_SERVER_NAME={{ urbackup.server_host }}
      - URBACKUP_CLIENT_NAME={{ ansible_hostname }}
      - URBACKUP_CLIENT_AUTHKEY={{ urbackup.authkey }}
    volumes:
      - "{{ docker.docker_dir }}/volumes:/backup"
    command:
      - --internet-only
      - -r
      - server-confirms
    networks:
      - backup

networks:
  proxy_network:
    external: true
  backup:
